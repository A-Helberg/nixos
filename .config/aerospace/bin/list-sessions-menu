#!/usr/bin/env bb

(require '[babashka.process :refer [sh]]
         '[clojure.string :as str]
         '[cheshire.core :as json]
         '[babashka.fs :as fs])

(def bin-dir (fs/expand-home "~/.config/aerospace/bin"))

(defn get-workspaces []
  (let [out (:out (sh "aerospace" "list-workspaces" "--monitor" "all" "--empty" "no"))]
    (remove str/blank? (str/split-lines out))))

(defn find-best-key [name used-keys]
  (let [lower-name (str/lower-case name)
        ;; Try to find first char in name that isn't used
        char-key (some #(let [c (str %)]
                          (when (and (re-matches #"[a-z0-9]" c)
                                     (not (contains? used-keys c)))
                            c))
                       lower-name)]
    (or char-key
        ;; Fallback: try 1-9, then a-z
        (some #(let [c (str %)]
                 (when (not (contains? used-keys c))
                   c))
              (concat (map str (range 1 10))
                      (map char (range (int \a) (inc (int \z)))))))))

(defn underline-char [name char-key]
  (if-let [idx (str/index-of (str/lower-case name) char-key)]
    (let [before (subs name 0 idx)
          target (str (get name idx))
          after (subs name (inc idx))]
      ;; Append Unicode Combining Low Line (U+0332)
      (str before target "\u0332" after))
    name))

(defn generate-menu []
  ;; 1. Define Static Actions (tmux-like)
  (let [static-items [{:key "$"
                       :type "command"
                       :label "Rename Session"
                       :value (str bin-dir "/gui-rename-session")}
                      {:key "c"
                       :type "command"
                       :label "Create Session"
                       :value (str bin-dir "/gui-create-session")}
                      {:key "x"
                       :type "command"
                       :label "Kill Session"
                       :value (str bin-dir "/gui-kill-session")}]
        
        used-keys-init (set (map :key static-items))
        
        ;; 2. Generate Dynamic Session Items
        workspaces (get-workspaces)
        dynamic-items-result (reduce (fn [acc name]
                                       (let [used-keys (:used-keys acc)
                                             key (find-best-key name used-keys)]
                                         (if key
                                           (-> acc
                                               (update :items conj {:key key
                                                                    :type "command"
                                                                    :label (underline-char name key)
                                                                    :value (str "aerospace workspace \"" name "\"")})
                                               (update :used-keys conj key))
                                           acc)))
                                     {:items [] :used-keys used-keys-init}
                                     workspaces)
        
        all-items (concat static-items (:items dynamic-items-result))]
    
    (println (json/generate-string all-items {:pretty true}))))

(generate-menu)
